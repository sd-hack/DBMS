Assignment No 8
Problem statements: Database trigger (an types:row level and statement level trigger,before and after trigger). Write a database trigger on library table.the system should keep track of the records that are being updated or deleted.the old value of updated or deleted records should be added be library_audit table.

********************************************************************************

mysql> CREATE DATABASE LIBRARY; 
Query OK, 1 row affected (0.00 sec) 

mysql> USE LIBRARY; 
Database changed 

mysql> CREATE TABLE BORROWER(ROLLNO INT(10),NAME VARCHAR(11),DATEOFISSUE DATE,NAMEOFBOOK VARCHAR(10),STATUS CHAR(10)); 
Query OK, 0 rows affected (0.09 sec) 

mysql> DESC BORROWER; 
+-------------+-------------+------+-----+---------+-------+ 
| Field       | Type        | Null | Key | Default | Extra | 
+-------------+-------------+------+-----+---------+-------+ 
| ROLLNO      | int(10)     | YES  |     | NULL    |       | 
| NAME        | varchar(11) | YES  |     | NULL    |       | 
| DATEOFISSUE | date        | YES  |     | NULL    |       | 
| NAMEOFBOOK  | varchar(10) | YES  |     | NULL    |       | 
| STATUS      | char(10)    | YES  |     | NULL    |       | 
+-------------+-------------+------+-----+---------+-------+ 
5 rows in set (0.00 sec) 

mysql> INSERT INTO BORROWER(ROLLNO,NAME,DATEOFISSUE,NAMEOFBOOK,STATUS) 
    VALUES 
    ('101','RAM','2017-06-17','DBMS','R'), 
    ('102','SHAM','2017-07-20','ISEE','I'), 
    ('103','SITA','2017-07-15','SE','R'), 
    ('104','MITA','2017-08-26','TOC','I'); 
Query OK, 4 rows affected (0.05 sec) 
Records: 4  Duplicates: 0  Warnings: 0 

mysql> SELECT *FROM BORROWER; 
+--------+------+-------------+------------+--------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | 
+--------+------+-------------+------------+--------+ 
|    101 | RAM  | 2017-06-17  | DBMS       | R      | 
|    102 | SHAM | 2017-07-20  | ISEE       | I      | 
|    103 | SITA | 2017-07-15  | SE         | R      | 
|    104 | MITA | 2017-08-26  | TOC        | I      | 
+--------+------+-------------+------------+--------+ 
4 rows in set (0.00 sec) 


mysql> CREATE TABLE LIBRARY_AUDIT(ROLLNO INT(10) PRIMARY KEY,NAME VARCHAR(10),DATEOFISSUE DATE,NAMEOFBOOK VARCHAR(10),STATUS CHAR(2),TS TIMESTAMP); 
Query OK, 0 rows affected (0.10 sec) 

mysql>  DESC LIBRARY_AUDIT; 
+-------------+-------------+------+-----+-------------------+-----------------------------+ 
| Field       | Type        | Null | Key | Default           | Extra                       | 
+-------------+-------------+------+-----+-------------------+-----------------------------+ 
| ROLLNO      | int(10)     | PRI |     | NULL              |                             | 
| NAME        | varchar(10) | YES  |     | NULL              |                             | 
| DATEOFISSUE | date        | YES  |     | NULL              |                             | 
| NAMEOFBOOK  | varchar(10) | YES  |     | NULL              |                             | 
| STATUS      | char(2)     | YES  |     | NULL              |                             | 
| TS          | timestamp   | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP | 
+-------------+-------------+------+-----+-------------------+-----------------------------+ 
6 rows in set (0.00 sec) 


mysql>  DELIMITER // 
mysql> CREATE TRIGGER AFTER_TRIGGER AFTER INSERT ON BORROWER FOR EACH ROW 
BEGIN 
INSERT INTO LIBRARY_AUDIT VALUES(NEW.ROLLNO,NEW.NAME,NEW.DATEOFISSUE,NEW.NAMEOFBOOK,NEW.STATUS,CURRENT_TIMESTAMP); 
END; // 
Query OK, 0 rows affected (0.11 sec) 


mysql> SELECT *FROM LIBRARY_AUDIT;  // 
Empty set (0.00 sec) 


mysql> INSERT INTO BORROWER VALUES('106','GITA','2017-08-27','DBMS','I'); // 
Query OK, 1 row affected (0.03 sec) 

mysql> SELECT *FROM BORROWER; // 
+--------+------+-------------+------------+--------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | 
+--------+------+-------------+------------+--------+ 
|    101 | RAM  | 2017-06-17  | DBMS       | R      | 
|    102 | SHAM | 2017-07-20  | ISEE       | I      | 
|    103 | SITA | 2017-07-15  | SE         | R      | 
|    104 | MITA | 2017-08-26  | TOC        | I      | 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 
+--------+------+-------------+------------+--------+ 
5 rows in set (0.00 sec) 

mysql> SELECT *FROM LIBRARY_AUDIT; // 
+--------+------+-------------+------------+--------+---------------------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | TS                  | 
+--------+------+-------------+------------+--------+---------------------+ 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 2017-09-07 19:37:32 | 
+--------+------+-------------+------------+--------+---------------------+ 
1 row in set (0.00 sec)


mysql> CREATE TRIGGER AFTER_DELETE AFTER DELETE ON BORROWER FOR EACH ROW 
BEGIN 
INSERT INTO LIBRARY_AUDIT VALUES(OLD.ROLLNO,OLD.NAME,OLD.DATEOFISSUE,OLD.NAMEOFBOOK,OLD.STATUS,CURRENT_TIMESTAMP); 
END; // 
Query OK, 0 rows affected (0.07 sec) 

mysql> DELETE FROM BORROWER WHERE ROLLNO=104; // 
Query OK, 1 row affected (0.05 sec) 

mysql> SELECT *FROM LIBRARY_AUDIT; // 
+--------+------+-------------+------------+--------+---------------------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | TS                  | 
+--------+------+-------------+------------+--------+---------------------+ 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 2017-09-07 19:37:32 | 
|    104 | MITA | 2017-08-26  | TOC        | I      | 2017-09-07 19:43:39 | 
+--------+------+-------------+------------+--------+---------------------+ 
2 rows in set (0.01 sec) 


mysql> CREATE TRIGGER AFTER_UPDATE AFTER UPDATE ON BORROWER FOR EACH ROW 
BEGIN 
INSERT INTO LIBRARY_AUDIT VALUES(NEW.ROLLNO,NEW.NAME,NEW.DATEOFISSUE,NEW.NAMEOFBOOK,NEW.STATUS,CURRENT_TIMESTAMP); 
END; // 
Query OK, 0 rows affected (0.12 sec) 

mysql> UPDATE BORROWER SET STATUS='R' WHERE BORROWER.ROLLNO='102'; // 
Query OK, 1 row affected (0.07 sec) 
Rows matched: 1  Changed: 1  Warnings: 0 

mysql> SELECT *FROM LIBRARY_AUDIT; // 
+--------+------+-------------+------------+--------+---------------------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | TS                  | 
+--------+------+-------------+------------+--------+---------------------+ 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 2017-09-07 19:37:32 | 
|    104 | MITA | 2017-08-26  | TOC        | I      | 2017-09-07 19:43:39 | 
|    102 | SHAM | 2017-07-20  | ISEE       | R      | 2017-09-07 19:47:03 | 
+--------+------+-------------+------------+--------+---------------------+ 
3 rows in set (0.00 sec) 


mysql> DELIMITER // 
mysql> CREATE TRIGGER BEFORE_INSERT BEFORE INSERT ON BORROWER FOR EACH ROW 
BEGIN 
INSERT INTO LIBRARY_AUDIT VALUES(NEW.ROLLNO,NEW.NAME,NEW.DATEOFISSUE,NEW.NAMEOFBOOK,NEW.STATUS,CURRENT_TIMESTAMP); 
END; // 
Query OK, 0 rows affected (0.11 sec) 

mysql> INSERT INTO BORROWER VALUES('107','DEV','2017--09-17','TOC','R'); // 
Query OK, 1 row affected (0.10 sec) 

mysql> SELECT *FROM BORROWER; // 
+--------+------+-------------+------------+--------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | 
+--------+------+-------------+------------+--------+ 
|    101 | RAM  | 2017-06-17  | DBMS       | R      | 
|    102 | SHAM | 2017-07-20  | ISEE       | R      | 
|    103 | SITA | 2017-07-15  | SE         | R      | 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 
+--------+------+-------------+------------+--------+ 
5 rows in set (0.00 sec) 

mysql> SELECT *FROM LIBRARY_AUDIT; // 
+--------+------+-------------+------------+--------+---------------------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | TS                  | 
+--------+------+-------------+------------+--------+---------------------+ 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 2017-09-07 19:37:32 | 
|    104 | MITA | 2017-08-26  | TOC        | I      | 2017-09-07 19:43:39 | 
|    102 | SHAM | 2017-07-20  | ISEE       | R      | 2017-09-07 19:47:03 | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 2017-09-07 19:48:16 | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 2017-09-07 19:48:16 | 
+--------+------+-------------+------------+--------+---------------------+ 
5 rows in set (0.00 sec) 


mysql> CREATE TRIGGER BEFORE_DELETE BEFORE DELETE ON BORROWER FOR EACH ROW 
BEGIN 
INSERT INTO LIBRARY_AUDIT VALUES(OLD.ROLLNO,OLD.NAME,OLD.DATEOFISSUE,OLD.NAMEOFBOOK,OLD.STATUS,CURRENT_TIMESTAMP); 
END; // 
Query OK, 0 rows affected (0.08 sec) 

mysql> DELETE FROM BORROWER WHERE ROLLNO=103; // 
Query OK, 1 row affected (0.05 sec) 

mysql> SELECT *FROM BORROWER; // 
+--------+------+-------------+------------+--------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | 
+--------+------+-------------+------------+--------+ 
|    101 | RAM  | 2017-06-17  | DBMS       | R      | 
|    102 | SHAM | 2017-07-20  | ISEE       | R      | 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 
+--------+------+-------------+------------+--------+ 
4 rows in set (0.00 sec) 

mysql> SELECT *FROM LIBRARY_AUDIT; // 
+--------+------+-------------+------------+--------+---------------------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | TS                  | 
+--------+------+-------------+------------+--------+---------------------+ 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 2017-09-07 19:37:32 | 
|    104 | MITA | 2017-08-26  | TOC        | I      | 2017-09-07 19:43:39 | 
|    102 | SHAM | 2017-07-20  | ISEE       | R      | 2017-09-07 19:47:03 | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 2017-09-07 19:48:16 | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 2017-09-07 19:48:16 | 
|    103 | SITA | 2017-07-15  | SE         | R      | 2017-09-07 19:51:03 | 
|    103 | SITA | 2017-07-15  | SE         | R      | 2017-09-07 19:51:03 | 
+--------+------+-------------+------------+--------+---------------------+ 
7 rows in set (0.00 sec) 


mysql> CREATE TRIGGER BEFORE_UPDATE BEFORE UPDATE ON BORROWER FOR EACH ROW 
BEGIN 
INSERT INTO LIBRARY_AUDIT VALUES(NEW.ROLLNO,NEW.NAME,NEW.DATEOFISSUE,NEW.NAMEOFBOOK,NEW.STATUS,CURRENT_TIMESTAMP); 
END; // 
Query OK, 0 rows affected (0.07 sec) 

mysql> UPDATE BORROWER SET STATUS='R' WHERE BORROWER.ROLLNO='106'; // 
Query OK, 1 row affected (0.04 sec) 
Rows matched: 1  Changed: 1  Warnings: 0 

mysql> SELECT *FROM BORROWER; // 
+--------+------+-------------+------------+--------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | 
+--------+------+-------------+------------+--------+ 
|    101 | RAM  | 2017-06-17  | DBMS       | R      | 
|    102 | SHAM | 2017-07-20  | ISEE       | R      | 
|    106 | GITA | 2017-08-27  | DBMS       | R      | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 
+--------+------+-------------+------------+--------+ 
4 rows in set (0.00 sec) 
 
mysql> SELECT *FROM LIBRARY_AUDIT; // 
+--------+------+-------------+------------+--------+---------------------+ 
| ROLLNO | NAME | DATEOFISSUE | NAMEOFBOOK | STATUS | TS                  | 
+--------+------+-------------+------------+--------+---------------------+ 
|    106 | GITA | 2017-08-27  | DBMS       | I      | 2017-09-07 19:37:32 | 
|    104 | MITA | 2017-08-26  | TOC        | I      | 2017-09-07 19:43:39 | 
|    102 | SHAM | 2017-07-20  | ISEE       | R      | 2017-09-07 19:47:03 | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 2017-09-07 19:48:16 | 
|    107 | DEV  | 2017-09-17  | TOC        | R      | 2017-09-07 19:48:16 | 
|    103 | SITA | 2017-07-15  | SE         | R      | 2017-09-07 19:51:03 | 
|    103 | SITA | 2017-07-15  | SE         | R      | 2017-09-07 19:51:03 | 
|    106 | GITA | 2017-08-27  | DBMS       | R      | 2017-09-07 19:53:25 | 
|    106 | GITA | 2017-08-27  | DBMS       | R      | 2017-09-07 19:53:25 | 
+--------+------+-------------+------------+--------+---------------------+ 
9 rows in set (0.00 sec) 
